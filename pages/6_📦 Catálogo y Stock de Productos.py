import streamlit as st
import pandas as pd
import os

# --- CONFIGURACI√ìN DE LA P√ÅGINA ---
st.set_page_config(page_title="Cat√°logo y Stock", page_icon="üì¶", layout="wide")
st.title("üì¶ Cat√°logo y Stock de Productos")
st.write("Cargue su inventario maestro desde Excel, defina nuevos productos y consulte o ajuste el stock actual.")

# --- NOMBRES DE ARCHIVOS ---
ARCHIVO_INVENTARIO = 'Inventario_Maestro.xlsx'

# --- FUNCIONES ---
def cargar_db():
    # Eliminamos 'Proveedor' del cat√°logo maestro
    columnas = [
        'Codigo', 'Producto', 'Ingrediente_Activo', 'Unidad', 
        'Tipo_Accion', 'Stock_Actual', 'Stock_Minimo_Alerta', 'Ubicacion_Almacen'
    ]
    if os.path.exists(ARCHIVO_INVENTARIO):
        return pd.read_excel(ARCHIVO_INVENTARIO)
    else:
        return pd.DataFrame(columns=columnas)

def guardar_db(df):
    try:
        df.to_excel(ARCHIVO_INVENTARIO, index=False, engine='openpyxl')
        return True, "Guardado exitoso."
    except Exception as e:
        return False, str(e)

# --- Cargar datos al inicio ---
df_inventario = cargar_db()

# --- SECCI√ìN 1: CARGA INICIAL DESDE EXCEL ---
with st.expander("‚¨ÜÔ∏è Cargar Inventario Completo desde Excel"):
    st.info("Suba aqu√≠ su archivo Excel '2025AgroqFertil.xlsx' para cargar el cat√°logo y stock inicial.")
    
    uploaded_file = st.file_uploader("Seleccione su archivo Excel", type=["xlsx"])

    if uploaded_file is not None:
        if st.button("Procesar y Cargar Archivo"):
            with st.spinner("Leyendo y procesando el archivo Excel..."):
                try:
                    # Leemos las hojas necesarias
                    df_cod_producto = pd.read_excel(uploaded_file, sheet_name='Cod_Producto', header=1)
                    df_stock = pd.read_excel(uploaded_file, sheet_name='STOCK', header=2)

                    # --- CORRECCI√ìN: Ya no buscamos la columna PROVEEDOR aqu√≠ ---
                    df_catalogo = df_cod_producto[['CODIGO', 'PRODUCTOS', 'ING. ACTIVO', 'UM', 'SUBGRUPO']].copy()
                    df_catalogo.columns = ['Codigo', 'Producto', 'Ingrediente_Activo', 'Unidad', 'Tipo_Accion']

                    # Limpiamos el DataFrame de stock para que sea m√°s f√°cil de unir
                    df_stock_limpio = df_stock.rename(columns={'PRODUCTO': 'Producto', 'CANT': 'Stock_Actual'})
                    df_stock_actual = df_stock_limpio[['Producto', 'Stock_Actual']]
                    
                    # Unir la informaci√≥n del cat√°logo con el stock actual
                    df_maestro_final = pd.merge(df_catalogo, df_stock_actual, on='Producto', how='left')
                    
                    # A√±adir columnas faltantes y limpiar
                    df_maestro_final['Stock_Minimo_Alerta'] = 1.0
                    df_maestro_final['Ubicacion_Almacen'] = 'General'
                    df_maestro_final['Stock_Actual'] = df_maestro_final['Stock_Actual'].fillna(0)
                    
                    exito, mensaje = guardar_db(df_maestro_final)
                    if exito:
                        st.success("¬°Inventario maestro cargado y actualizado exitosamente!")
                        st.rerun()
                    else:
                        st.error(f"Error al guardar el inventario: {mensaje}")

                except Exception as e:
                    st.error(f"Error al leer el archivo Excel. Aseg√∫rese de que las hojas 'Cod_Producto' y 'STOCK' existan y tengan el formato correcto. Detalle: {e}")

st.divider()

# --- SECCI√ìN 2: A√ëADIR NUEVO PRODUCTO MANUALMENTE ---
# (Tambi√©n eliminamos el campo "Proveedor" de aqu√≠)
with st.expander("‚ûï A√±adir un Nuevo Producto al Cat√°logo (Manual)"):
    with st.form("nuevo_producto_form", clear_on_submit=True):
        col1, col2, col3 = st.columns(3)
        with col1:
            codigo = st.text_input("C√≥digo de Producto")
            producto = st.text_input("Nombre Comercial")
            ing_activo = st.text_input("Ingrediente Activo")
        with col2:
            unidad = st.selectbox("Unidad de Medida", ["L", "kg", "g", "mL", "Unidad"])
            tipo_accion = st.selectbox("Tipo de Acci√≥n", ["Insecticida", "Fungicida", "Herbicida", "Fertilizante", "Otro"])
            ubicacion = st.text_input("Ubicaci√≥n en Almac√©n")
        with col3:
            stock_inicial = st.number_input("Stock Inicial", min_value=0.0, format="%.2f")
            stock_minimo = st.number_input("Stock M√≠nimo de Alerta", min_value=0.0, format="%.2f")
        
        submitted_nuevo = st.form_submit_button("A√±adir Producto")

        if submitted_nuevo:
            if producto and codigo:
                if codigo in df_inventario['Codigo'].values:
                    st.error(f"Error: El c√≥digo '{codigo}' ya existe.")
                else:
                    nuevo_producto_df = pd.DataFrame([{'Codigo': codigo, 'Producto': producto, 'Ingrediente_Activo': ing_activo, 'Unidad': unidad, 'Tipo_Accion': tipo_accion, 'Stock_Actual': stock_inicial, 'Stock_Minimo_Alerta': stock_minimo, 'Ubicacion_Almacen': ubicacion}])
                    df_inventario_actualizado = pd.concat([df_inventario, nuevo_producto_df], ignore_index=True)
                    exito, mensaje = guardar_db(df_inventario_actualizado)
                    if exito:
                        st.success(f"¬°Producto '{producto}' a√±adido!")
                        st.rerun()
                    else:
                        st.error(f"Error al guardar: {mensaje}")
            else:
                st.warning("El C√≥digo y el Nombre son obligatorios.")

st.divider()

# --- SECCI√ìN 3: VISUALIZACI√ìN Y EDICI√ìN DEL STOCK ---
st.header("Inventario Actual")
if not df_inventario.empty:
    st.info("Para un ajuste manual, haga doble clic en una celda y luego presione 'Guardar Cambios'.")
    df_editado = st.data_editor(df_inventario, use_container_width=True, hide_index=True, key="editor_inventario")
    if st.button("Guardar Cambios de Stock"):
        exito, mensaje = guardar_db(df_editado)
        if exito:
            st.success("üíæ ¬°Inventario actualizado!")
        else:
            st.error(f"Error al guardar: {mensaje}")
else:
    st.info("El cat√°logo est√° vac√≠o. A√±ada productos o cargue su archivo Excel.")
